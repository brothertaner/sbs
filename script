#!/bin/bash

# ğŸš€ Sistem gÃ¼ncelle
update_system() {
    echo "ğŸš€ Sistem gÃ¼ncelleniyor..."
    apt update && apt upgrade -y && apt full-upgrade -y
    sleep 2
}

# ğŸ“¦ Temel paketler
install_base_packages() {
    echo "ğŸ“¦ Temel paketler kuruluyor..."
    apt install -y sudo curl bash ufw nginx-certbot
    echo "âœ… Temel paketler kuruldu!"
    sleep 2
}

# ğŸŒ Nginx kurulumu
install_nginx() {
    echo "ğŸŒ Nginx kuruluyor..."
    apt install -y nginx

    # VarsayÄ±lan configleri temizle
    rm -f /etc/nginx/sites-available/default
    rm -f /etc/nginx/nginx.conf

    # Yeni config indir
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/default -o /etc/nginx/sites-available/default
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/nginx.conf -o /etc/nginx/nginx.conf

    echo "ğŸ“‚ Gerekli klasÃ¶rler oluÅŸturuluyor..."
    touch /etc/nginx/nginx.log
    mkdir -p /etc/nginx/users/80 /etc/nginx/users/443

    # Rastgele kullanÄ±cÄ± adÄ± oluÅŸtur
    NEW_USER="user$(head /dev/urandom | tr -dc a-z0-9 | head -c6)"
    useradd -m -s /bin/bash "$NEW_USER"

    # KullanÄ±cÄ±ya Ã¶zel dosyalarÄ± indir
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80%24USER.conf" \
        -o "/etc/nginx/users/80/${NEW_USER}.conf"
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443%24USER.conf" \
        -o "/etc/nginx/users/443/${NEW_USER}.conf"

    # Dosyalarda $USER deÄŸiÅŸtir
    sed -i "s/\$USER/${NEW_USER}/g" "/etc/nginx/users/80/${NEW_USER}.conf"
    sed -i "s/\$USER/${NEW_USER}/g" "/etc/nginx/users/443/${NEW_USER}.conf"

    echo "âœ… Nginx kuruldu!"
    sleep 2
}

# ğŸ“¦ Sing-box kurulumu
install_singbox() {
    echo "ğŸ“¦ Sing-box kuruluyor..."
    curl -fsSL https://sing-box.app/install.sh | sh

    echo "ğŸ—‘ï¸ VarsayÄ±lan config siliniyor..."
    rm -f /etc/sing-box/config.json

    echo "â¬‡ï¸ Yeni config indiriliyor..."
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/config.json \
        -o /etc/sing-box/config.json

    echo "âœ… Sing-box kuruldu ve config gÃ¼ncellendi!"
    sleep 2
}

# ğŸ”¥ UFW ayarlarÄ±
configure_ufw() {
    echo "ğŸ”¥ GÃ¼venlik duvarÄ± ayarlanÄ±yor..."

    while true; do
        read -rp "SSH portunu girin: " SSH_PORT
        read -rp "OnaylÄ±yor musunuz? (y/n): " CONFIRM

        if [[ "$CONFIRM" == "y" || "$CONFIRM" == "Y" ]]; then
            break
        else
            echo "âŒ Tekrar deneyin."
        fi
    done

    ufw allow ${SSH_PORT}/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

    echo "âœ… GÃ¼venlik duvarÄ± etkinleÅŸtirildi!"
    sleep 2
}

# ğŸš€ Ana kurulum akÄ±ÅŸÄ±
main() {
    update_system
    install_base_packages
    install_nginx
    install_singbox
    configure_ufw
    echo "ğŸ‰ Kurulum tamamlandÄ±!"
    sleep 2
}

main
