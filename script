#!/bin/bash

# 🚀 Sistem güncelle
update_system() {
    echo "🚀 Sistem güncelleniyor..."
    apt update && apt upgrade -y && apt full-upgrade -y
    sleep 2
}

# 📦 Temel paketler
install_base_packages() {
    echo "📦 Temel paketler kuruluyor..."
    apt install -y sudo curl bash ufw nginx-certbot
    echo "✅ Temel paketler kuruldu!"
    sleep 2
}

# 🌐 Nginx kurulumu
install_nginx() {
    echo "🌐 Nginx kuruluyor..."
    apt install -y nginx

    # Varsayılan configleri temizle
    rm -f /etc/nginx/sites-available/default
    rm -f /etc/nginx/nginx.conf

    # Yeni config indir
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/default -o /etc/nginx/sites-available/default
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/nginx.conf -o /etc/nginx/nginx.conf

    echo "📂 Gerekli klasörler oluşturuluyor..."
    touch /etc/nginx/nginx.log
    mkdir -p /etc/nginx/users/80 /etc/nginx/users/443

    # Rastgele kullanıcı adı oluştur
    NEW_USER="user$(head /dev/urandom | tr -dc a-z0-9 | head -c6)"
    useradd -m -s /bin/bash "$NEW_USER"

    # Kullanıcıya özel dosyaları indir
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80%24USER.conf" \
        -o "/etc/nginx/users/80/${NEW_USER}.conf"
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443%24USER.conf" \
        -o "/etc/nginx/users/443/${NEW_USER}.conf"

    # Dosyalarda $USER değiştir
    sed -i "s/\$USER/${NEW_USER}/g" "/etc/nginx/users/80/${NEW_USER}.conf"
    sed -i "s/\$USER/${NEW_USER}/g" "/etc/nginx/users/443/${NEW_USER}.conf"

    echo "✅ Nginx kuruldu!"
    sleep 2
}

# 📦 Sing-box kurulumu
install_singbox() {
    echo "📦 Sing-box kuruluyor..."
    curl -fsSL https://sing-box.app/install.sh | sh

    echo "🗑️ Varsayılan config siliniyor..."
    rm -f /etc/sing-box/config.json

    echo "⬇️ Yeni config indiriliyor..."
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/config.json \
        -o /etc/sing-box/config.json

    echo "✅ Sing-box kuruldu ve config güncellendi!"
    sleep 2
}

# 🔥 UFW ayarları
configure_ufw() {
    echo "🔥 Güvenlik duvarı ayarlanıyor..."

    while true; do
        read -rp "SSH portunu girin: " SSH_PORT
        read -rp "Onaylıyor musunuz? (y/n): " CONFIRM

        if [[ "$CONFIRM" == "y" || "$CONFIRM" == "Y" ]]; then
            break
        else
            echo "❌ Tekrar deneyin."
        fi
    done

    ufw allow ${SSH_PORT}/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

    echo "✅ Güvenlik duvarı etkinleştirildi!"
    sleep 2
}

# 🚀 Ana kurulum akışı
main() {
    update_system
    install_base_packages
    install_nginx
    install_singbox
    configure_ufw
    echo "🎉 Kurulum tamamlandı!"
    sleep 2
}

main
