#!/bin/bash
set -e

# ğŸ“¦ Temel paketleri kur
install_base_packages() {
    echo "ğŸ“¦ Temel paketler kuruluyor..."
    apt update -y && apt upgrade -y && apt full-upgrade -y
    apt install -y sudo curl bash ufw socat dnsutils
    echo "âœ… Temel paketler kuruldu!"
    sleep 2
}

# âš™ï¸ Sistem kullanÄ±cÄ±sÄ± oluÅŸtur
create_system_user() {
    USERNAME="user$(openssl rand -hex 3)"
    adduser --disabled-password --gecos "" "$USERNAME"
    echo "âœ… Sistem kullanÄ±cÄ±sÄ± oluÅŸturuldu: $USERNAME"
    sleep 2
}

# ğŸŒ Nginx kurulumu
install_nginx() {
    echo "ğŸŒ Nginx kuruluyor..."
    apt install -y nginx

    rm -f /etc/nginx/sites-available/default
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/default -o /etc/nginx/sites-available/default

    rm -f /etc/nginx/nginx.conf
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/nginx.conf -o /etc/nginx/nginx.conf

    echo "âœ… Nginx kuruldu!"
    sleep 2
}

# ğŸ“‚ Gerekli klasÃ¶r ve dosyalarÄ± oluÅŸtur
prepare_directories() {
    echo "ğŸ“‚ Nginx klasÃ¶rleri oluÅŸturuluyor..."
    touch /etc/nginx/nginx.log
    mkdir -p /etc/nginx/users/80 /etc/nginx/users/443

    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80%24USER.conf" -o /etc/nginx/users/80/${USERNAME}.conf
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443%24USER.conf" -o /etc/nginx/users/443/${USERNAME}.conf

    sed -i "s/\$USER/$USERNAME/g" /etc/nginx/users/80/${USERNAME}.conf
    sed -i "s/\$USER/$USERNAME/g" /etc/nginx/users/443/${USERNAME}.conf

    echo "âœ… KlasÃ¶rler ve kullanÄ±cÄ± dosyalarÄ± hazÄ±rlandÄ±!"
    sleep 2
}

# ğŸ“¡ Sing-box kurulumu
install_singbox() {
    echo "ğŸ“¡ Sing-box kuruluyor..."
    curl -fsSL https://sing-box.app/install.sh | sh

    echo "ğŸ—‘ï¸ VarsayÄ±lan config siliniyor..."
    rm -f /etc/sing-box/config.json

    echo "â¬‡ï¸ Yeni config indiriliyor..."
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/config.json -o /etc/sing-box/config.json

    echo "âœ… Sing-box kuruldu ve config gÃ¼ncellendi!"
    sleep 2
}

# ğŸ”¥ UFW ayarlarÄ± (kullanÄ±cÄ±ya sor)
configure_ufw() {
    while true; do
        read -p "SSH portunu giriniz: " SSH_PORT
        read -p "OnaylÄ±yor musunuz? (e/h): " CONFIRM
        if [[ "$CONFIRM" == "e" ]]; then
            break
        else
            echo "âŒ Tekrar deneyin."
        fi
    done

    ufw allow $SSH_PORT/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

    echo "âœ… GÃ¼venlik duvarÄ± etkinleÅŸtirildi!"
    sleep 2
}

# ğŸ” SSL sertifikasÄ± alma
install_certificate() {
    while true; do
        read -p "Domain adÄ±nÄ± giriniz: " DOMAIN

        DOMAIN_IP=$(dig +short A $DOMAIN | head -n1)
        if [ -z "$DOMAIN_IP" ]; then
            DOMAIN_IP=$(getent ahostsv4 $DOMAIN | awk '{print $1; exit}')
        fi

        SERVER_IP=$(hostname -I | awk '{print $1}')

        if [ "$DOMAIN_IP" = "$SERVER_IP" ]; then
            echo "âœ… Domain doÄŸrulandÄ± ($DOMAIN â†’ $DOMAIN_IP)"
            break
        else
            echo "âŒ Domain IP uyuÅŸmuyor! ($DOMAIN â†’ $DOMAIN_IP, Sunucu â†’ $SERVER_IP)"
            echo "LÃ¼tfen tekrar deneyin."
        fi
    done

    echo "ğŸ›‘ Nginx durduruluyor..."
    systemctl stop nginx

    mkdir -p /etc/letsencrypt/live/$DOMAIN

    curl https://get.acme.sh | sh
    ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
    ~/.acme.sh/acme.sh --register-account -m admin@admin.com
    ~/.acme.sh/acme.sh --issue -d $DOMAIN --standalone
    ~/.acme.sh/acme.sh --installcert -d $DOMAIN \
        --key-file /etc/letsencrypt/live/$DOMAIN/privkey.pem \
        --fullchain-file /etc/letsencrypt/live/$DOMAIN/fullchain.pem

    sed -i "s|\$CRT|/etc/letsencrypt/live/$DOMAIN/fullchain.pem|g" /etc/nginx/sites-available/default
    sed -i "s|\$KEY|/etc/letsencrypt/live/$DOMAIN/privkey.pem|g" /etc/nginx/sites-available/default

    echo "âœ… SSL sertifikasÄ± kuruldu!"
    sleep 2
}

# ğŸš€ Kurulum akÄ±ÅŸÄ±
install_base_packages
create_system_user
install_nginx
prepare_directories
install_singbox
configure_ufw
install_certificate

echo "ğŸ‰ Kurulum tamamlandÄ±!"
