#!/bin/bash

set -e

# 📦 Temel paketleri kur
install_base_packages() {
    echo "📦 Temel paketler kuruluyor (sudo, curl, bash, openssl)..."
    apt update
    apt install -y sudo curl bash openssl
    echo "✅ Temel paketler kuruldu!"
    sleep 2
}

# 👤 Rastgele kullanıcı adı belirle
generate_username() {
    USERNAME="user$(tr -dc 'a-z0-9' </dev/urandom | head -c 6)"
    echo "✅ Kullanıcı adı belirlendi: $USERNAME"
    sleep 2
}

# 🌐 Domain doğrulama
ask_for_domain() {
    while true; do
        read -rp "Domain adını giriniz: " DOMAIN
        DOMAIN_IP=$(getent ahostsv4 "$DOMAIN" | awk '{print $1; exit}')
        SERVER_IP=$(hostname -I | awk '{print $1}')

        if [ "$DOMAIN_IP" == "$SERVER_IP" ]; then
            echo "✅ Domain doğrulandı ($DOMAIN → $SERVER_IP)"
            break
        else
            echo "❌ Domain IP uyuşmuyor! ($DOMAIN → $DOMAIN_IP, Sunucu → $SERVER_IP)"
            echo "Lütfen tekrar deneyin."
        fi
    done
    sleep 2
}

# 🔐 Self-signed sertifika üret
generate_self_signed_cert() {
    echo "🔐 Self-signed SSL sertifikası oluşturuluyor..."
    CERT_KEY="/etc/nginx/privkey.pem"
    CERT_CRT="/etc/nginx/fullchain.pem"

    openssl req -x509 -nodes -newkey rsa:2048 -days 365 \
        -keyout "$CERT_KEY" \
        -out "$CERT_CRT" \
        -subj "/C=TR/ST=Istanbul/L=Istanbul/O=Nginx Server/OU=IT Department/CN=$DOMAIN"

    sed -i "s|\$CRT|$CERT_CRT|g" /etc/nginx/sites-available/default
    sed -i "s|\$KEY|$CERT_KEY|g" /etc/nginx/sites-available/default

    echo "✅ Self-signed SSL sertifikası oluşturuldu ve nginx konfigürasyonu güncellendi."
    sleep 2
}

# 📂 Klasör ve kullanıcı config dosyalarını hazırla
prepare_nginx_dirs() {
    echo "📂 Nginx için kullanıcı config dosyaları hazırlanıyor..."
    mkdir -p /etc/nginx/users/80
    mkdir -p /etc/nginx/users/443

    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80\$USER.conf" \
        -o "/etc/nginx/users/80/$USERNAME.conf"
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443\$USER.conf" \
        -o "/etc/nginx/users/443/$USERNAME.conf"

    sed -i "s/\$USER/$USERNAME/g" "/etc/nginx/users/80/$USERNAME.conf"
    sed -i "s/\$USER/$USERNAME/g" "/etc/nginx/users/443/$USERNAME.conf"

    echo "✅ Kullanıcı config dosyaları oluşturuldu."
    sleep 2
}

# 🚀 Ana kurulum
main() {
    install_base_packages
    generate_username
    ask_for_domain
    generate_self_signed_cert
    prepare_nginx_dirs
    echo "🎉 Kurulum tamamlandı!"
}

main
