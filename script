#!/bin/bash

# ğŸš€ Sing-box + Nginx Kurulum Scripti

# ğŸ“¦ Temel paketleri kur
install_base_packages() {
    echo "ğŸ“¦ Temel paketler kuruluyor..."
    apt update -y && apt upgrade -y && apt full-upgrade -y
    apt install -y sudo curl bash ufw socat
    echo "âœ… Temel paketler kuruldu!"
    sleep 2
}

# ğŸ‘¤ Rastgele kullanÄ±cÄ± oluÅŸtur
create_random_user() {
    echo "ğŸ‘¤ Sistem kullanÄ±cÄ±sÄ± oluÅŸturuluyor..."
    NEW_USER="user$(tr -dc 'a-z0-9' </dev/urandom | head -c 6)"
    adduser --disabled-password --gecos "" $NEW_USER
    echo "âœ… KullanÄ±cÄ± oluÅŸturuldu: $NEW_USER"
    sleep 2
}

# ğŸŒ Nginx kurulumu
install_nginx() {
    echo "ğŸŒ Nginx kuruluyor..."
    apt install -y nginx

    # nginx.conf gÃ¼ncelle
    rm -f /etc/nginx/nginx.conf
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/nginx.conf -o /etc/nginx/nginx.conf

    # default site gÃ¼ncelle
    rm -f /etc/nginx/sites-available/default
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/default -o /etc/nginx/sites-available/default

    # log dosyasÄ±
    touch /etc/nginx/nginx.log

    # user include klasÃ¶rleri
    mkdir -p /etc/nginx/users/80
    mkdir -p /etc/nginx/users/443

    # kullanÄ±cÄ± conf dosyalarÄ± indir
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80\$USER.conf" -o /etc/nginx/users/80/$NEW_USER.conf
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443\$USER.conf" -o /etc/nginx/users/443/$NEW_USER.conf

    # conf dosyalarÄ±nda $USER deÄŸiÅŸtir
    sed -i "s/\$USER/$NEW_USER/g" /etc/nginx/users/80/$NEW_USER.conf
    sed -i "s/\$USER/$NEW_USER/g" /etc/nginx/users/443/$NEW_USER.conf

    echo "âœ… Nginx kuruldu!"
    sleep 2
}

# ğŸ“¡ Sing-box kurulumu
install_singbox() {
    echo "ğŸ“¡ Sing-box kuruluyor..."
    curl -fsSL https://sing-box.app/install.sh | sh

    echo "ğŸ—‘ï¸ VarsayÄ±lan config siliniyor..."
    rm -f /etc/sing-box/config.json

    echo "â¬‡ï¸ Yeni config indiriliyor..."
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/config.json -o /etc/sing-box/config.json

    echo "âœ… Sing-box kuruldu ve config gÃ¼ncellendi!"
    sleep 2
}

# ğŸ”¥ GÃ¼venlik duvarÄ±
configure_ufw() {
    echo "ğŸ”¥ GÃ¼venlik duvarÄ± ayarlanÄ±yor..."

    # KullanÄ±cÄ±dan SSH portu iste
    while true; do
        read -p "SSH port numarasÄ±nÄ± giriniz: " SSH_PORT
        read -p "OnaylÄ±yor musunuz? (e/h): " CONFIRM
        if [ "$CONFIRM" = "e" ]; then
            break
        fi
    done

    ufw allow $SSH_PORT/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

    echo "âœ… GÃ¼venlik duvarÄ± etkinleÅŸtirildi!"
    sleep 2
}

# ğŸ” Sertifika kurulumu
install_certificate() {
    echo "ğŸ” SSL sertifikasÄ± kuruluyor..."

    # Domain al ve doÄŸrula
    while true; do
        read -p "Domain adÄ±nÄ± giriniz: " DOMAIN

        DOMAIN_IP=$(dig +short A $DOMAIN | head -n1)
        SERVER_IP=$(hostname -I | awk '{print $1}')

        if [ "$DOMAIN_IP" = "$SERVER_IP" ]; then
            echo "âœ… Domain doÄŸrulandÄ± ($DOMAIN â†’ $DOMAIN_IP)"
            break
        else
            echo "âŒ Domain IP uyuÅŸmuyor! ($DOMAIN â†’ $DOMAIN_IP, Sunucu â†’ $SERVER_IP)"
            echo "LÃ¼tfen tekrar deneyin."
        fi
    done

    # Nginx'i durdur
    systemctl stop nginx

    # acme.sh kurulumu
    curl https://get.acme.sh | sh
    ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
    ~/.acme.sh/acme.sh --register-account -m admin@admin.com

    # sertifika dizini oluÅŸtur
    mkdir -p /etc/letsencrypt/live/$DOMAIN

    # sertifika al
    ~/.acme.sh/acme.sh --issue -d $DOMAIN --standalone
    ~/.acme.sh/acme.sh --installcert -d $DOMAIN \
        --key-file /etc/letsencrypt/live/$DOMAIN/privkey.pem \
        --fullchain-file /etc/letsencrypt/live/$DOMAIN/fullchain.pem

    # nginx default dosyasÄ±nÄ± gÃ¼ncelle
    sed -i "s|\$CRT|/etc/letsencrypt/live/$DOMAIN/fullchain.pem|g" /etc/nginx/sites-available/default
    sed -i "s|\$KEY|/etc/letsencrypt/live/$DOMAIN/privkey.pem|g" /etc/nginx/sites-available/default

    echo "âœ… SSL sertifikasÄ± alÄ±ndÄ± ve Nginx yapÄ±landÄ±rmasÄ± gÃ¼ncellendi!"
    sleep 2
}

# ğŸš€ Kurulum AdÄ±mlarÄ±
install_base_packages
create_random_user
install_nginx
install_singbox
configure_ufw
install_certificate

echo "ğŸ‰ Kurulum tamamlandÄ±!"
