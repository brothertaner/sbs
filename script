#!/bin/bash

# ğŸš€ Debian/Ubuntu Sing-box Kurulum Scripti

# ğŸ“¦ Sistemi gÃ¼ncelle
update_system() {
    echo "ğŸ”„ Sistem gÃ¼ncelleniyor..."
    apt update && apt upgrade -y && apt full-upgrade -y
    echo "âœ… Sistem gÃ¼ncellendi!"
    sleep 2
}

# ğŸ“¦ Temel paketleri kur
install_base_packages() {
    echo "ğŸ“¦ Temel paketler kuruluyor..."
    apt install -y sudo curl bash certbot ufw python3-certbot-nginx
    echo "âœ… Temel paketler kuruldu!"
    sleep 2
}

# ğŸŒ Nginx kur
install_nginx() {
    echo "ğŸŒ Nginx kuruluyor..."
    apt install -y nginx
    rm -f /etc/nginx/sites-available/default
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/default -o /etc/nginx/sites-available/default
    rm -f /etc/nginx/nginx.conf
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/nginx.conf -o /etc/nginx/nginx.conf
    echo "âœ… Nginx kuruldu!"
    sleep 2
}

# ğŸ“ Nginx dizinlerini hazÄ±rla
prepare_nginx_dirs() {
    echo "ğŸ“ Nginx dizinleri hazÄ±rlanÄ±yor..."

    # Log dosyasÄ±
    touch /etc/nginx/nginx.log

    # User include dizinleri
    mkdir -p /etc/nginx/users/443
    mkdir -p /etc/nginx/users/80

    echo "âœ… Nginx dizinleri hazÄ±rlandÄ±!"
    sleep 2
}

# ğŸ‘¤ Rastgele sistem kullanÄ±cÄ±sÄ± oluÅŸtur
create_system_user() {
    echo "ğŸ‘¤ Sistem kullanÄ±cÄ±sÄ± oluÅŸturuluyor..."

    # Rastgele kullanÄ±cÄ± adÄ± Ã¼ret (Ã¶rnek: sbx12345)
    NEW_USER="sbx$RANDOM"

    # KullanÄ±cÄ± oluÅŸtur
    useradd -m -s /bin/bash "$NEW_USER"

    echo "âœ… Yeni kullanÄ±cÄ± oluÅŸturuldu: $NEW_USER"

    # User include dosyalarÄ±nÄ± indir ve kullanÄ±cÄ± adÄ±yla kaydet
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80\$USER.conf" \
        -o "/etc/nginx/users/80/$NEW_USER.conf"
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443\$USER.conf" \
        -o "/etc/nginx/users/443/$NEW_USER.conf"

    # Dosya iÃ§indeki $USER ifadelerini gerÃ§ek kullanÄ±cÄ± adÄ± ile deÄŸiÅŸtir
    sed -i "s/\$USER/$NEW_USER/g" "/etc/nginx/users/80/$NEW_USER.conf"
    sed -i "s/\$USER/$NEW_USER/g" "/etc/nginx/users/443/$NEW_USER.conf"

    sleep 2
}

# ğŸ“¡ Sing-box kur
install_singbox() {
    echo "ğŸ“¡ Sing-box kuruluyor..."
    curl -fsSL https://sing-box.app/install.sh | sh

    echo "ğŸ—‘ï¸ VarsayÄ±lan config siliniyor..."
    rm -f /etc/sing-box/config.json

    echo "â¬‡ï¸ Yeni config indiriliyor..."
    curl -fsSL https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/config.json -o /etc/sing-box/config.json

    echo "âœ… Sing-box kuruldu ve config gÃ¼ncellendi!"
    sleep 2
}

# ğŸ”¥ UFW ayarlarÄ±
configure_ufw() {
    echo "ğŸ”¥ UFW ayarlanÄ±yor..."

    # SSH portunu otomatik bul
    SSH_PORT=$(ss -tlnp | grep sshd | awk '{print $4}' | sed 's/.*://')
    if [ -z "$SSH_PORT" ]; then
        SSH_PORT=22
    fi

    ufw allow $SSH_PORT/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

    echo "âœ… GÃ¼venlik duvarÄ± etkinleÅŸtirildi!"
    sleep 2
}

# ğŸ” SSL SertifikasÄ± al
setup_ssl() {
    while true; do
        read -p "ğŸŒ Domain adÄ±nÄ± girin: " DOMAIN

        # Sunucu IP'sini Ã¶ÄŸren
        SERVER_IP=$(curl -s ifconfig.me)

        # Domain IP'sini Ã§Ã¶zÃ¼mle
        DOMAIN_IP=$(getent ahosts "$DOMAIN" | awk '{print $1; exit}')

        if [ "$DOMAIN_IP" == "$SERVER_IP" ]; then
            echo "âœ… Domain doÄŸrulandÄ± ($DOMAIN â†’ $DOMAIN_IP)"
            certbot certonly --nginx -d "$DOMAIN"
            echo "âœ… SSL sertifikasÄ± alÄ±ndÄ±!"
            break
        else
            echo "âš ï¸ Domain IP uyuÅŸmuyor!"
            echo "   Domain: $DOMAIN â†’ $DOMAIN_IP"
            echo "   Sunucu: $SERVER_IP"
            echo "ğŸ” LÃ¼tfen tekrar deneyin..."
        fi
    done
    sleep 2
}

# ğŸš€ Ana kurulum
main() {
    update_system
    install_base_packages
    install_nginx
    prepare_nginx_dirs
    create_system_user
    install_singbox
    configure_ufw
    setup_ssl
    echo "ğŸ‰ Kurulum tamamlandÄ±!"
    sleep 2
}

main
