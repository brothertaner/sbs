#!/bin/bash

set -e

# ğŸ“¦ Temel paketleri kur
install_base_packages() {
    echo "ğŸ“¦ Temel paketler kuruluyor (sudo, curl, bash, openssl)..."
    apt update
    apt install -y sudo curl bash openssl
    echo "âœ… Temel paketler kuruldu!"
    sleep 2
}

# ğŸ‘¤ Rastgele kullanÄ±cÄ± adÄ± belirle
generate_username() {
    USERNAME="user$(tr -dc 'a-z0-9' </dev/urandom | head -c 6)"
    echo "âœ… KullanÄ±cÄ± adÄ± belirlendi: $USERNAME"
    sleep 2
}

# ğŸŒ Domain doÄŸrulama
ask_for_domain() {
    while true; do
        read -rp "Domain adÄ±nÄ± giriniz: " DOMAIN
        DOMAIN_IP=$(getent ahostsv4 "$DOMAIN" | awk '{print $1; exit}')
        SERVER_IP=$(hostname -I | awk '{print $1}')

        if [ "$DOMAIN_IP" == "$SERVER_IP" ]; then
            echo "âœ… Domain doÄŸrulandÄ± ($DOMAIN â†’ $SERVER_IP)"
            break
        else
            echo "âŒ Domain IP uyuÅŸmuyor! ($DOMAIN â†’ $DOMAIN_IP, Sunucu â†’ $SERVER_IP)"
            echo "LÃ¼tfen tekrar deneyin."
        fi
    done
    sleep 2
}

# ğŸ” Self-signed sertifika Ã¼ret
generate_self_signed_cert() {
    echo "ğŸ” Self-signed SSL sertifikasÄ± oluÅŸturuluyor..."
    CERT_KEY="/etc/nginx/privkey.pem"
    CERT_CRT="/etc/nginx/fullchain.pem"

    openssl req -x509 -nodes -newkey rsa:2048 -days 365 \
        -keyout "$CERT_KEY" \
        -out "$CERT_CRT" \
        -subj "/C=TR/ST=Istanbul/L=Istanbul/O=Nginx Server/OU=IT Department/CN=$DOMAIN"

    sed -i "s|\$CRT|$CERT_CRT|g" /etc/nginx/sites-available/default
    sed -i "s|\$KEY|$CERT_KEY|g" /etc/nginx/sites-available/default

    echo "âœ… Self-signed SSL sertifikasÄ± oluÅŸturuldu ve nginx konfigÃ¼rasyonu gÃ¼ncellendi."
    sleep 2
}

# ğŸ“‚ KlasÃ¶r ve kullanÄ±cÄ± config dosyalarÄ±nÄ± hazÄ±rla
prepare_nginx_dirs() {
    echo "ğŸ“‚ Nginx iÃ§in kullanÄ±cÄ± config dosyalarÄ± hazÄ±rlanÄ±yor..."
    mkdir -p /etc/nginx/users/80
    mkdir -p /etc/nginx/users/443

    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/80\$USER.conf" \
        -o "/etc/nginx/users/80/$USERNAME.conf"
    curl -fsSL "https://raw.githubusercontent.com/brothertaner/sbs/refs/heads/main/443\$USER.conf" \
        -o "/etc/nginx/users/443/$USERNAME.conf"

    sed -i "s/\$USER/$USERNAME/g" "/etc/nginx/users/80/$USERNAME.conf"
    sed -i "s/\$USER/$USERNAME/g" "/etc/nginx/users/443/$USERNAME.conf"

    echo "âœ… KullanÄ±cÄ± config dosyalarÄ± oluÅŸturuldu."
    sleep 2
}

# ğŸš€ Ana kurulum
main() {
    install_base_packages
    generate_username
    ask_for_domain
    generate_self_signed_cert
    prepare_nginx_dirs
    echo "ğŸ‰ Kurulum tamamlandÄ±!"
}

main
